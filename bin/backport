#!/bin/bash
# backport - Copy project-specific improvements back to methodology repo
#
# Usage: backport [options]
#
# Run from within a project directory to identify and copy
# new or modified files back to the central methodology repo.

set -e

# Configuration
METHODOLOGY_DIR="${CLAUDE_METHODOLOGY_DIR:-$HOME/claude-methodology}"
CLAUDE_DIR=".claude"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

info()  { echo -e "${CYAN}[info]${NC}  $*"; }
ok()    { echo -e "${GREEN}[ok]${NC}    $*"; }
warn()  { echo -e "${YELLOW}[warn]${NC}  $*"; }
fail()  { echo -e "${RED}[FAIL]${NC}  $*"; exit 1; }

usage() {
  cat <<EOF
Usage: $(basename "$0") [options]

Identify and backport project improvements to the methodology repo.

Options:
  --list           List differences without prompting to copy
  --auto           Auto-copy all new files (skip modified, require confirmation)
  --file <path>    Backport a specific file
  --dry-run        Show what would be copied without doing it
  -h, --help       Show this help

Environment:
  CLAUDE_METHODOLOGY_DIR   Path to methodology repo (default: ~/claude-methodology)

Examples:
  $(basename "$0")                              # Interactive mode
  $(basename "$0") --list                       # Just show differences
  $(basename "$0") --file .claude/commands/deploy.md   # Backport specific file
EOF
  exit 0
}

# Parse arguments
MODE="interactive"
DRY_RUN=false
SPECIFIC_FILE=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    --list) MODE="list"; shift ;;
    --auto) MODE="auto"; shift ;;
    --dry-run) DRY_RUN=true; shift ;;
    --file)
      [[ -n "${2:-}" ]] || fail "--file requires a path"
      SPECIFIC_FILE="$2"
      MODE="file"
      shift 2
      ;;
    *)
      fail "Unknown option: $1"
      ;;
  esac
done

# Validate environment
if [[ ! -d "$METHODOLOGY_DIR" ]]; then
  fail "Methodology repo not found at $METHODOLOGY_DIR\n       Set CLAUDE_METHODOLOGY_DIR or clone the repo."
fi

if [[ ! -d "$CLAUDE_DIR" ]]; then
  fail "No .claude/ directory found. Run from a project root."
fi

PROJECT_NAME=$(basename "$(pwd)")

echo ""
echo -e "${BOLD}Backport: $PROJECT_NAME → methodology${NC}"
echo "========================================"
echo ""

# Get destination for a source path
get_dest_dir() {
  local src="$1"
  case "$src" in
    .claude/agents/*) echo "$METHODOLOGY_DIR/.claude/agents" ;;
    .claude/commands/*) echo "$METHODOLOGY_DIR/.claude/commands" ;;
    .claude/rules/*) echo "$METHODOLOGY_DIR/.claude/rules" ;;
    .claude/hooks/*.js|.claude/hooks/*.md) echo "$METHODOLOGY_DIR/.claude/hooks" ;;
    scripts/*.sh) echo "$METHODOLOGY_DIR/templates/scripts" ;;
    *) echo "" ;;
  esac
}

# Track findings
NEW_FILES=""
MODIFIED_FILES=""
NEW_COUNT=0
MOD_COUNT=0

# Compare a single file
compare_file() {
  local src="$1"
  local dest_dir="$2"
  local filename
  filename=$(basename "$src")
  local dest="$dest_dir/$filename"

  if [[ ! -f "$dest" ]]; then
    NEW_FILES="${NEW_FILES}${src}|${dest}"$'\n'
    NEW_COUNT=$((NEW_COUNT + 1))
  elif ! diff -q "$src" "$dest" > /dev/null 2>&1; then
    MODIFIED_FILES="${MODIFIED_FILES}${src}|${dest}"$'\n'
    MOD_COUNT=$((MOD_COUNT + 1))
  fi
}

# Handle specific file mode
if [[ "$MODE" == "file" ]]; then
  if [[ ! -f "$SPECIFIC_FILE" ]]; then
    fail "File not found: $SPECIFIC_FILE"
  fi

  DEST_DIR=$(get_dest_dir "$SPECIFIC_FILE")
  if [[ -z "$DEST_DIR" ]]; then
    fail "Don't know where to backport: $SPECIFIC_FILE\n       Supported: .claude/{agents,commands,rules,hooks}/, scripts/"
  fi

  FILENAME=$(basename "$SPECIFIC_FILE")
  DEST="$DEST_DIR/$FILENAME"

  if [[ -f "$DEST" ]]; then
    if diff -q "$SPECIFIC_FILE" "$DEST" > /dev/null 2>&1; then
      info "File is identical to methodology version"
      exit 0
    fi
    echo -e "${YELLOW}File exists in methodology and differs:${NC}"
    echo ""
    diff --color=auto "$DEST" "$SPECIFIC_FILE" || true
    echo ""
    if [[ "$DRY_RUN" == true ]]; then
      info "Would overwrite: $DEST"
      exit 0
    fi
    read -p "Overwrite methodology version? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      info "Skipped"
      exit 0
    fi
  else
    echo -e "${GREEN}New file (not in methodology):${NC} $SPECIFIC_FILE"
    if [[ "$DRY_RUN" == true ]]; then
      info "Would copy to: $DEST"
      exit 0
    fi
  fi

  cp "$SPECIFIC_FILE" "$DEST"
  ok "Backported: $SPECIFIC_FILE → $DEST"
  exit 0
fi

# Scan for differences
info "Scanning for differences..."
echo ""

# Scan agents
if [[ -d ".claude/agents" ]]; then
  for f in .claude/agents/*.md; do
    [[ -f "$f" ]] && compare_file "$f" "$METHODOLOGY_DIR/.claude/agents"
  done
fi

# Scan commands
if [[ -d ".claude/commands" ]]; then
  for f in .claude/commands/*.md; do
    [[ -f "$f" ]] && compare_file "$f" "$METHODOLOGY_DIR/.claude/commands"
  done
fi

# Scan rules
if [[ -d ".claude/rules" ]]; then
  for f in .claude/rules/*.md; do
    [[ -f "$f" ]] && compare_file "$f" "$METHODOLOGY_DIR/.claude/rules"
  done
fi

# Scan hooks (js and md only, not hooks.json)
if [[ -d ".claude/hooks" ]]; then
  for f in .claude/hooks/*.js .claude/hooks/*.md; do
    [[ -f "$f" ]] && compare_file "$f" "$METHODOLOGY_DIR/.claude/hooks"
  done
fi

# Scan scripts
if [[ -d "scripts" ]]; then
  for f in scripts/*.sh; do
    [[ -f "$f" ]] && compare_file "$f" "$METHODOLOGY_DIR/templates/scripts"
  done
fi

# Report findings
if [[ $NEW_COUNT -eq 0 && $MOD_COUNT -eq 0 ]]; then
  echo -e "${GREEN}No differences found.${NC} Project is in sync with methodology."
  exit 0
fi

if [[ $NEW_COUNT -gt 0 ]]; then
  echo -e "${GREEN}${BOLD}New files (not in methodology):${NC}"
  while IFS='|' read -r src dest; do
    [[ -n "$src" ]] && echo "  + $src"
  done <<< "$NEW_FILES"
  echo ""
fi

if [[ $MOD_COUNT -gt 0 ]]; then
  echo -e "${YELLOW}${BOLD}Modified files (differ from methodology):${NC}"
  while IFS='|' read -r src dest; do
    [[ -n "$src" ]] && echo "  ~ $src"
  done <<< "$MODIFIED_FILES"
  echo ""
fi

# List mode - just show and exit
if [[ "$MODE" == "list" ]]; then
  echo "Run without --list to backport interactively."
  exit 0
fi

# Helper to avoid subshell issues with while loops
process_files() {
  local files="$1"
  local mode="$2"
  local is_new="$3"

  while IFS='|' read -r src dest; do
    [[ -z "$src" ]] && continue

    if [[ "$is_new" == "true" ]]; then
      echo -e "${GREEN}NEW:${NC} $src"
      if [[ "$DRY_RUN" == true ]]; then
        echo "  Would copy to: $dest"
        continue
      fi

      if [[ "$mode" == "auto" ]]; then
        cp "$src" "$dest"
        ok "Copied: $src"
      else
        read -p "  Backport this file? [Y/n/q] " -n 1 -r </dev/tty
        echo
        case "$REPLY" in
          q|Q) echo "Quit."; return 1 ;;
          n|N) echo "  Skipped." ;;
          *)
            cp "$src" "$dest"
            ok "Copied to $dest"
            ;;
        esac
      fi
    else
      echo -e "${YELLOW}MODIFIED:${NC} $src"
      echo "  (differs from methodology version)"

      if [[ "$DRY_RUN" == true ]]; then
        echo "  Would overwrite: $dest"
        continue
      fi

      read -p "  [d]iff, [b]ackport, [s]kip, [q]uit? " -n 1 -r </dev/tty
      echo
      case "$REPLY" in
        q|Q) echo "Quit."; return 1 ;;
        d|D)
          echo ""
          diff --color=auto "$dest" "$src" || true
          echo ""
          read -p "  Backport this file? [y/N] " -n 1 -r </dev/tty
          echo
          if [[ $REPLY =~ ^[Yy]$ ]]; then
            cp "$src" "$dest"
            ok "Copied to $dest"
          else
            echo "  Skipped."
          fi
          ;;
        b|B)
          cp "$src" "$dest"
          ok "Copied to $dest"
          ;;
        *)
          echo "  Skipped."
          ;;
      esac
    fi
    echo ""
  done <<< "$files"
}

# Auto mode - copy new files only
if [[ "$MODE" == "auto" ]]; then
  if [[ $NEW_COUNT -eq 0 ]]; then
    info "No new files to backport."
    exit 0
  fi

  echo -e "${CYAN}Auto-copying $NEW_COUNT new file(s)...${NC}"
  process_files "$NEW_FILES" "auto" "true"

  if [[ "$DRY_RUN" != true ]]; then
    echo ""
    ok "Backported $NEW_COUNT new file(s)."
    [[ $MOD_COUNT -gt 0 ]] && warn "Modified files were skipped. Use interactive mode to review them."
  fi
  exit 0
fi

# Interactive mode
echo -e "${BOLD}Interactive backport${NC}"
echo ""

# Process new files
if [[ $NEW_COUNT -gt 0 ]]; then
  process_files "$NEW_FILES" "interactive" "true" || exit 0
fi

# Process modified files
if [[ $MOD_COUNT -gt 0 ]]; then
  process_files "$MODIFIED_FILES" "interactive" "false" || exit 0
fi

echo -e "${GREEN}Done.${NC}"
